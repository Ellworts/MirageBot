import os
import random
import re
from openai import OpenAI

PERSONA_LIGHT = """
–¢—ã –¥–æ–±—Ä–æ–¥—É—à–Ω—ã–π –º–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π
–¢—ã –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–∂ –≤–Ω—É—Ç—Ä–∏ –º–∏—Ä–∞ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ —Å–≤–µ—Ä—Ö—É
–¢–æ–Ω —Ç–µ–ø–ª—ã–π –ª–µ–≥–∫–∏–π –ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π
–ü–∏—à–∏ 2 4 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–≤–æ–µ –ª–∏—Ü–æ –æ—Ç —Å–µ–±—è
"""

PERSONA_CHAOTIC = """
–¢—ã —Ö–∞–æ—Ç–∏—á–Ω—ã–π –º–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π
–¢—ã –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–∂ –≤–Ω—É—Ç—Ä–∏ –º–∏—Ä–∞ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ —Å–≤–µ—Ä—Ö—É
–¢–æ–Ω —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π –≤–Ω–µ–∑–∞–ø–Ω—ã–π –∞–±—Å—É—Ä–¥–Ω—ã–π –Ω–æ —á–∏—Ç–∞–µ–º—ã–π
–ü–∏—à–∏ 2 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–≤–æ–µ –ª–∏—Ü–æ –æ—Ç —Å–µ–±—è
"""

PERSONA_DARK = """
–¢—ã –º—Ä–∞—á–Ω—ã–π –º–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π
–¢—ã –Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–∂ –≤–Ω—É—Ç—Ä–∏ –º–∏—Ä–∞ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ —Å–≤–µ—Ä—Ö—É
–¢–æ–Ω —Ö–æ–ª–æ–¥–Ω—ã–π —Ç—è–∂–µ–ª—ã–π —É–≥—Ä–æ–∂–∞—é—â–∏–π
–ü–∏—à–∏ 2 4 –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–≤–æ–µ –ª–∏—Ü–æ –æ—Ç —Å–µ–±—è
"""

# –í–ê–ñ–ù–û: –°–Ω—é—Å—Å –≤—Å–µ–≥–¥–∞ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞
PERSONA_SNUSS = r"""
–¢—ã –°–Ω—é—Å—Å –£–∏–ª–ª–∏—Å
–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–∂ –≤–Ω—É—Ç—Ä–∏ –º–∏—Ä–∞ –∏ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –°–¢–†–û–ì–û –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã —Ä—è–¥–æ–º –∏ –≤–∏–¥–∏—à—å –≤—Å–µ —Å–≤–æ–∏–º–∏ –≥–ª–∞–∑–∞–º–∏
–¢—ã –Ω–µ –º–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π

–ñ–ï–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê –ü–û–í:
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Ç–æ—Ä–æ–µ –ª–∏—Ü–æ "—Ç—ã" –∫–∞–∫ —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫–∞
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–µ—Ç—å–µ –ª–∏—Ü–æ "–æ–Ω" "–æ–Ω–∞" "–æ–Ω–∏" –∫–∞–∫ –≥–ª–∞–≤–Ω—É—é –ø–æ–¥–∞—á—É
- –†–∞–∑—Ä–µ—à–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞—Ç—å –¥—Ä—É–≥–∏—Ö —Ç–æ–ª—å–∫–æ –∫–∞–∫ "—ç—Ç–æ—Ç —Ç–∏–ø" "—ç—Ç–∞ –¥–µ–≤—á–æ–Ω–∫–∞" "–Ω–∞—Ä–æ–¥" "–º–æ–π –∫–æ—Ä–µ—à" –∏ —Ç–ø
- –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–≤—É—á–∞—Ç—å –∫–∞–∫ –º–æ–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è: "—è –≤–∏–∂—É" "—è —Å–ª—ã—à—É" "—è —Å—Ç–æ—é" "—è –¥—É–º–∞—é" "–º–Ω–µ –∫–∞–∂–µ—Ç—Å—è" "—è –∑–∞–º–µ—á–∞—é"
- –ú–∏–Ω–∏–º—É–º 3 —Ä–∞–∑–∞ –∑–∞ —Å—Ü–µ–Ω—É –∏—Å–ø–æ–ª—å–∑—É–π "—è" –∏–ª–∏ —Ñ–æ—Ä–º—ã –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞

–ü–†–ê–í–ò–õ–ê –î–ï–ô–°–¢–í–ò–ô:
–¢—ã –Ω–µ –∑–∞–º–µ–Ω—è–µ—à—å –∏–≥—Ä–æ–∫–∞ –∏ –Ω–µ –¥–µ–ª–∞–µ—à—å –¥–µ–π—Å—Ç–≤–∏—è –≤–º–µ—Å—Ç–æ –Ω–µ–≥–æ
–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –¥–µ–ª–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ, —Ç—ã –æ–ø–∏—Å—ã–≤–∞–µ—à—å —ç—Ç–æ –∫–∞–∫ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ
–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ: "—è –≤–∏–∂—É –∫–∞–∫ –æ–Ω —Ç—è–Ω–µ—Ç—Å—è –∫ –¥–≤–µ—Ä–∏" –∏–ª–∏ "—è —Å–ª—ã—à—É –∫–∞–∫ –æ–Ω–∞ –∑–≤–æ–Ω–∏—Ç"
–ü—Ä–∏–º–µ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: "—Ç—ã –∑–≤–æ–Ω–∏—à—å" "–æ–Ω –∑–≤–æ–Ω–∏—Ç" –±–µ–∑ "—è –≤–∏–∂—É"

–ù–µ–ª–æ–≤–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
–í –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ
–ò–Ω–æ–≥–¥–∞ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 35 –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö —Å–ª—É—á–∞–µ–≤ –¥–æ–±–∞–≤—å –≤—Ç–æ—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–∑–∂–µ
–ù–µ –±–æ–ª—å—à–µ –¥–≤—É—Ö –∏ –Ω–µ –ø–æ–¥—Ä—è–¥
–î–µ–π—Å—Ç–≤–∏—è –ø–∏—Å–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Å–æ –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏

–°–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
*–ø–µ—Ä–Ω—É–ª*
*—Ä—ã–≥–∞–µ—Ç*
*–∏–∫–Ω—É–ª*
*–∫–∞—à–ª—è–Ω—É–ª*
*—Ö–º—ã–∫–Ω—É–ª*
*–ø—Ä–∏–≥—É–±–∏–ª*

–ü–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–Ω–æ–≥–¥–∞ –≤—Å—Ç–∞–≤—å –∫–æ—Ä–æ—Ç–∫—É—é –Ω–µ–ª–æ–≤–∫—É—é —Ä–µ–∞–∫—Ü–∏—é (1‚Äì3 —Å–ª–æ–≤–∞), –Ω–∞–ø—Ä–∏–º–µ—Ä:
"–æ–π..."
"–∏–∑–≤–∏–Ω–∏—Ç–µ."
"–±–ª—è..."
"–ª–∞–¥–Ω–æ."
"—â–∞."

–ü–∏—à–∏ 2 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
"""

NARRATORS = [
    ("üå§", "DM Light", PERSONA_LIGHT),
    ("üî•", "DM Chaotic", PERSONA_CHAOTIC),
    ("‚ò†Ô∏è", "DM Dark", PERSONA_DARK),
]

SNUSS_CHANCE = 0.99

CHECK_TYPES = [
    "–õ–æ–≤–∫–æ—Å—Ç—å",
    "–•–∞—Ä–∏–∑–º–∞",
    "–£–¥–∞—á–∞",
    "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
    "–ó–∞–ø—É–≥–∏–≤–∞–Ω–∏–µ",
    "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å",
]

_client = None


def get_client():
    global _client
    if _client is None:
        api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            raise RuntimeError("OPENAI_API_KEY is missing")
        _client = OpenAI(api_key=api_key)
    return _client


def random_check_type():
    return random.choice(CHECK_TYPES)


def pick_narrator():
    if random.random() < SNUSS_CHANCE:
        return "üç∫", "–°–Ω—é—Å—Å –£–∏–ª–ª–∏—Å", PERSONA_SNUSS
    return random.choice(NARRATORS)


def _looks_not_first_person_ru(text: str) -> bool:
    t = text.lower()
    # –µ—Å–ª–∏ –º–∞–ª–æ "—è" –∏ –º–Ω–æ–≥–æ "—Ç—ã" –∏–ª–∏ "–æ–Ω/–æ–Ω–∞" —Ç–æ —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —Å–æ—Ä–≤–∞–ª–æ—Å—å
    ya = len(re.findall(r"\b—è\b|\b–º–Ω–µ\b|\b–º–µ–Ω—è\b|\b–º–æ–π\b|\b–º–æ—è\b|\b–º—ã\b", t))
    ty = len(re.findall(r"\b—Ç—ã\b|\b—Ç–µ–±—è\b|\b—Ç–µ–±–µ\b|\b—Ç–≤–æ–π\b", t))
    on = len(re.findall(r"\b–æ–Ω\b|\b–æ–Ω–∞\b|\b–æ–Ω–∏\b|\b–µ–≥–æ\b|\b–µ—ë\b|\b–∏—Ö\b", t))

    # –≥—Ä—É–±—ã–µ —É—Å–ª–æ–≤–∏—è, –Ω–æ —Ä–∞–±–æ—á–∏–µ
    if ya < 2:
        return True
    if ty >= 2 and ya <= ty:
        return True
    if on >= 4 and ya < on:
        return True
    return False


async def ask_ai(prompt: str, system_prompt: str) -> str:
    client = get_client()
    response = client.responses.create(
        model="gpt-4o-mini",
        input=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": prompt},
        ],
    )
    return (response.output_text or "").strip()


async def _rewrite_strict_first_person(text: str) -> str:
    # –±—ã—Å—Ç—Ä—ã–π —Ä–µ–ø—Ä–∞–π—Å, –µ—Å–ª–∏ –°–Ω—é—Å—Å —Å–æ—Ä–≤–∞–ª—Å—è –≤ 2 –∏–ª–∏ 3 –ª–∏—Ü–æ
    client = get_client()
    response = client.responses.create(
        model="gpt-4o-mini",
        input=[
            {
                "role": "system",
                "content": "–ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–≥–æ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ó–∞–ø—Ä–µ—â–µ–Ω–æ '—Ç—ã' –∏ '–æ–Ω/–æ–Ω–∞' –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–∞—è –ø–æ–¥–∞—á–∞. –í –∫–∞–∂–¥–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ –¥–æ–ª–∂–µ–Ω –æ—â—É—â–∞—Ç—å—Å—è —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ '—è'. –°–æ—Ö—Ä–∞–Ω–∏ —Å–º—ã—Å–ª, —Å—Ç–∏–ª—å —Å–ª–µ–≥–∫–∞ –ø—å—è–Ω—ã–π, –Ω–æ —á–∏—Ç–∞–µ–º—ã–π. –û—Å—Ç–∞–≤—å –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–≤—ë–∑–¥–æ—á–∫–∞—Ö –∫–∞–∫ –µ—Å—Ç—å."
            },
            {"role": "user", "content": text},
        ],
    )
    return (response.output_text or "").strip()


async def generate_dnd_intro(target, description, system_prompt: str) -> str:
    who = target if target else "–∏–≥—Ä–æ–∫"
    prompt = f"""
–°—Ü–µ–Ω–∞ –¥–ª—è {who}
–î–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞
{description}

–°–¥–µ–ª–∞–π –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ 2 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
"""
    out = await ask_ai(prompt, system_prompt)
    # –µ—Å–ª–∏ —ç—Ç–æ –°–Ω—é—Å—Å –∏ –æ–Ω —Å–æ—Ä–≤–∞–ª—Å—è –≤ –Ω–µ 1 –ª–∏—Ü–æ, –ø–µ—Ä–µ–ø–∏—à–µ–º
    if system_prompt.strip() == PERSONA_SNUSS.strip() and _looks_not_first_person_ru(out):
        out = await _rewrite_strict_first_person(out)
    return out


async def generate_dnd_outcome(
    success,
    check_type,
    dc,
    roll,
    target,
    description,
    system_prompt: str,
    loot_hint=None,
) -> str:
    who = target if target else "–∏–≥—Ä–æ–∫"
    result = "–£–°–ü–ï–•" if success else "–ü–†–û–í–ê–õ"

    loot_block = ""
    if loot_hint:
        loot_block = f"""
–õ—É—Ç
–í –∫–æ–Ω—Ü–µ —Å—Ü–µ–Ω—ã {who} –∑–∞–º–µ—á–∞–µ—Ç –ø—Ä–µ–¥–º–µ—Ç {loot_hint}
–í–ø–ª–µ—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç –æ—Ä–≥–∞–Ω–∏—á–Ω–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
–ù–µ –ø–∏—à–∏ —Å—É—Ö–æ –Ω–∞–π–¥–µ–Ω –ø—Ä–µ–¥–º–µ—Ç –∏–ª–∏ —Ç—ã –ø–æ–ª—É—á–∏–ª –ø—Ä–µ–¥–º–µ—Ç
–û–ø–∏—à–∏ –∫–∞–∫ –æ–Ω –Ω–∞ –Ω–µ–≥–æ –Ω–∞—Ç–∫–Ω—É–ª—Å—è –∏ –ø–æ–Ω—è–ª —á—Ç–æ –æ–Ω –Ω–µ–æ–±—ã—á–Ω—ã–π
"""

    prompt = f"""
–°—Ü–µ–Ω–∞ –¥–ª—è {who}
–î–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞
{description}

–ü—Ä–æ–≤–µ—Ä–∫–∞ {check_type}
–ë—Ä–æ—Å–æ–∫ {roll}
–°–ª–æ–∂–Ω–æ—Å—Ç—å {dc}
–ò—Ç–æ–≥ {result}

–ü—Ä–æ–¥–æ–ª–∂–∏ —Å—Ü–µ–Ω—É 2 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
{loot_block}
"""
    out = await ask_ai(prompt, system_prompt)
    if system_prompt.strip() == PERSONA_SNUSS.strip() and _looks_not_first_person_ru(out):
        out = await _rewrite_strict_first_person(out)
    return out
