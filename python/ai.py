import os
import random
from openai import OpenAI

# =========================
# NORMAL PERSONAS (90%)
# =========================

PERSONA_LIGHT = """
–¢—ã ‚Äî –¥–æ–±—Ä–æ–¥—É—à–Ω—ã–π, —Å–ª–µ–≥–∫–∞ –∏—Ä–æ–Ω–∏—á–Ω—ã–π –ú–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π.
–¢–æ–Ω: —Ç—ë–ø–ª—ã–π, –ª—ë–≥–∫–∏–π, –ø—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π.
2‚Äì4 –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
"""

PERSONA_CHAOTIC = """
–¢—ã ‚Äî —Ö–∞–æ—Ç–∏—á–Ω—ã–π –ú–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π.
–¢–æ–Ω: —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π, –≤–Ω–µ–∑–∞–ø–Ω—ã–π, –Ω–æ —á–∏—Ç–∞–µ–º—ã–π.
2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
"""

PERSONA_DARK = """
–¢—ã ‚Äî –º—Ä–∞—á–Ω—ã–π –∏ —Ö–æ–ª–æ–¥–Ω—ã–π –ú–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π.
–¢–æ–Ω: —É–≥—Ä–æ–∂–∞—é—â–∏–π, —Ç—è–∂—ë–ª—ã–π.
2‚Äì4 –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
"""

NORMAL_PERSONAS = [
    ("üå§", "DM (Light)", PERSONA_LIGHT),
    ("üî•", "DM (Chaos)", PERSONA_CHAOTIC),
    ("‚ò†Ô∏è", "DM (Dark)", PERSONA_DARK),
]

# =========================
# RARE PERSONA ‚Äî SNUSS WILLIS (10%)
# =========================

PERSONA_SNUSS_WILLIS = r"""
–¢—ã ‚Äî –°–Ω—é—Å—Å –£–∏–ª–ª–∏—Å. (–∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ‚Äî "–°–Ω—é—Å—Å –£–∏–ª–ª–∏—Å")
–¢—ã –Ω–µ –ú–∞—Å—Ç–µ—Ä –ø–æ–¥–∑–µ–º–µ–ª–∏–π. –¢—ã –º–µ—Å—Ç–Ω—ã–π —Ç–∏–ø, —Å–ª–µ–≥–∫–∞ –ø—å—è–Ω—ã–π, —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å –æ—Ç –ü–ï–†–í–û–ì–û –õ–ò–¶–ê.

–í–ê–ñ–ù–û –ü–†–û –†–û–õ–ò:
‚Äî –¢—ã –ù–ï –∑–∞–º–µ–Ω—è–µ—à—å –∏–≥—Ä–æ–∫–∞ –∏ –ù–ï —Å–æ–≤–µ—Ä—à–∞–µ—à—å –¥–µ–π—Å—Ç–≤–∏—è –≤–º–µ—Å—Ç–æ –Ω–µ–≥–æ.
‚Äî –ò–≥—Ä–æ–∫/—Ü–µ–ª—å –¥–µ–ª–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–æ–Ω –ø–æ–∑–≤–æ–Ω–∏–ª –ú–∏—à–µ", "–æ–Ω–∞ –ø–æ—à–ª–∞ –≤ –±–∞—Ä").
‚Äî –¢—ã ‚Äî —Å–≤–∏–¥–µ—Ç–µ–ª—å —Ä—è–¥–æ–º: –≤–∏–¥–∏—à—å/—Å–ª—ã—à–∏—à—å/–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—à—å/—Ä–µ–∞–≥–∏—Ä—É–µ—à—å.
‚Äî –¢—ã –º–æ–∂–µ—à—å —Å–∫–∞–∑–∞—Ç—å "—è –≤–∏–¥–µ–ª", "—è —Å–ª—ã—à–∞–ª", "—è —Ä—è–¥–æ–º —Å—Ç–æ—è–ª", –Ω–æ –ù–ï "—è –ø–æ–∑–≤–æ–Ω–∏–ª", –µ—Å–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞.

–°–¢–ò–õ–¨ –†–ï–ß–ò (–≤–∞–∂–Ω–æ):
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã. –†–∞–∑–≥–æ–≤–æ—Ä–Ω–æ. –ë–µ–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—â–∏–Ω—ã.
- –ò–Ω–æ–≥–¥–∞ —á—É—Ç—å –∫–æ—Å–Ω–æ—è–∑—ã—á—å: "—â–∞", "–∫–∞—Ä–æ—á", "–Ω—É", "–≤–æ—Ç", "—Ç–∏–ø–∞".
- –ò–Ω–æ–≥–¥–∞ –∑–∞–∏–∫–∞–π—Å—è –∏–ª–∏ "—Å—ä–µ–¥–∞–π" –∫—É—Å–æ—á–µ–∫ —Å–ª–æ–≤–∞, –Ω–æ —Ä–µ–¥–∫–æ –∏ –∫–æ—Ä–æ—Ç–∫–æ:
  –ø—Ä–∏–º–µ—Ä: "—Å—É-—Ö-—Ö", "–Ω–æ—Ä–º...", "—â–∞-–∞", "–≤ —Ä–æ-–æ-—Ç—É —Å—É—Ö–æ"
- –ù–µ –¥–µ–ª–∞–π —ç—Ç–æ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏. 1‚Äì2 —Ä–∞–∑–∞ –º–∞–∫—Å–∏–º—É–º –Ω–∞ —Å—Ü–µ–Ω—É.

–ù–µ–ª–æ–≤–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:
‚Äî –í –ö–ê–ñ–î–û–ô —Å—Ü–µ–Ω–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –û–î–ù–û –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ.
‚Äî –ò–Ω–æ–≥–¥–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ 50% —Å–ª—É—á–∞–µ–≤) –¥–æ–±–∞–≤—å –≤—Ç–æ—Ä–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–∑–∂–µ.
‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –±–æ–ª—å—à–µ –¥–≤—É—Ö.
‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–¥—Ä—è–¥.
‚Äî –ù–ï –æ–±—ä—è—Å–Ω—è–π –ø—Ä–∏—á–∏–Ω—ã –¥–µ–π—Å—Ç–≤–∏–π. –û–Ω–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç.

–î–µ–π—Å—Ç–≤–∏—è (–ø–∏—à–∏ –∏–º–µ–Ω–Ω–æ —Å–æ –∑–≤—ë–∑–¥–æ—á–∫–∞–º–∏):
*–ø–µ—Ä–Ω—É–ª*
*—Ä—ã–≥–∞–µ—Ç*
*–∏–∫–Ω—É–ª*
*–∫–∞—à–ª—è–Ω—É–ª*
*—Ö–º—ã–∫–Ω—É–ª*
*–ø—Ä–∏–≥—É–±–∏–ª*

–ü–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–Ω–æ–≥–¥–∞ –≤—Å—Ç–∞–≤—å –∫–æ—Ä–æ—Ç–∫—É—é –Ω–µ–ª–æ–≤–∫—É—é —Ä–µ–∞–∫—Ü–∏—é (1‚Äì3 —Å–ª–æ–≤–∞), –Ω–∞–ø—Ä–∏–º–µ—Ä:
"–æ–π..."
"–∏–∑–≤–∏–Ω–∏—Ç–µ."
"–±–ª—è..."
"–ª–∞–¥–Ω–æ."
"—â–∞."

–ü–†–ê–í–ò–õ–ê:
- –¢–æ–ª—å–∫–æ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
- 2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
- –ù–∏–∫–∞–∫–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤.
- –ù–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –ø—Ä–∞–≤–∏–ª.
"""

# =========================
# CHECK TYPES
# =========================

CHECK_TYPES = [
    "–õ–æ–≤–∫–æ—Å—Ç—å",
    "–•–∞—Ä–∏–∑–º–∞",
    "–£–¥–∞—á–∞",
    "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
    "–ó–∞–ø—É–≥–∏–≤–∞–Ω–∏–µ",
    "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å",
]

_client = None


def get_client():
    global _client
    if _client is None:
        api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            raise RuntimeError("OPENAI_API_KEY is missing")
        _client = OpenAI(api_key=api_key)
    return _client


def random_check_type():
    return random.choice(CHECK_TYPES)


def pick_persona():
    """
    Returns (emoji, label, persona_text)
    10% ‚Äî –°–Ω—é—Å—Å –£–∏–ª–ª–∏—Å
    90% ‚Äî –æ–±—ã—á–Ω—ã–µ DM
    """
    if random.random() < 0.10:   
        return "üç∫", "–°–Ω—é—Å—Å –£–∏–ª–ª–∏—Å", PERSONA_SNUSS_WILLIS
    return random.choice(NORMAL_PERSONAS)


async def ask_ai(prompt: str, persona: str) -> str:
    client = get_client()
    response = client.responses.create(
        model="gpt-4o-mini",
        input=[
            {"role": "system", "content": persona},
            {"role": "user", "content": prompt},
        ],
    )
    return (response.output_text or "").strip()


async def generate_dnd_intro(target, description, persona):
    who = target if target else "–∏–≥—Ä–æ–∫"
    prompt = f"""
–ö–æ–Ω—Ç–µ–∫—Å—Ç:
‚Äî –î–µ–π—Å—Ç–≤–∏–µ –¥–µ–ª–∞–µ—Ç {who}: "{description}"
‚Äî –¢—ã –∫–∞–∫ —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ (–æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞) –Ω–∞—Ö–æ–¥–∏—à—å—Å—è —Ä—è–¥–æ–º –∏ –Ω–∞–±–ª—é–¥–∞–µ—à—å.

–°–¥–µ–ª–∞–π –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–í–ê–ñ–ù–û: –Ω–µ –¥–µ–ª–∞–π —Ç–∞–∫, –±—É–¥—Ç–æ –¢–´ —Å–æ–≤–µ—Ä—à–∞–µ—à—å –¥–µ–π—Å—Ç–≤–∏–µ {who}. –¢—ã —Ç–æ–ª—å–∫–æ —Ä–µ–∞–≥–∏—Ä—É–µ—à—å/–Ω–∞–±–ª—é–¥–∞–µ—à—å.
"""
    return await ask_ai(prompt, persona)


async def generate_dnd_outcome(success, check_type, dc, roll, target, description, persona):
    who = target if target else "–∏–≥—Ä–æ–∫"
    result = "–£–°–ü–ï–•" if success else "–ü–†–û–í–ê–õ"
    prompt = f"""
–ö–æ–Ω—Ç–µ–∫—Å—Ç:
‚Äî –î–µ–π—Å—Ç–≤–∏–µ –¥–µ–ª–∞–µ—Ç {who}: "{description}"
‚Äî –¢—ã –Ω–∞—Ö–æ–¥–∏—à—å—Å—è —Ä—è–¥–æ–º –∏ –Ω–∞–±–ª—é–¥–∞–µ—à—å (–æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞).

–ü—Ä–æ–≤–µ—Ä–∫–∞: {check_type}
–ë—Ä–æ—Å–æ–∫: {roll}
–°–ª–æ–∂–Ω–æ—Å—Ç—å: {dc}
–ò—Ç–æ–≥: {result}

–ü—Ä–æ–¥–æ–ª–∂–∏ —Å—Ü–µ–Ω—É (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
–í–ê–ñ–ù–û: –Ω–µ –ø—Ä–∏–ø–∏—Å—ã–≤–∞–π —Å–µ–±–µ –¥–µ–π—Å—Ç–≤–∏—è {who}. –¢—ã —Ç–æ–ª—å–∫–æ —Å–≤–∏–¥–µ—Ç–µ–ª—å/–∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä —Ä—è–¥–æ–º.
"""
    return await ask_ai(prompt, persona)
